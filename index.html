<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>RPG V10: Visuals & Stability</title>
    <style>
        /* CSS Styles */
        body { margin: 0; overflow: hidden; background: #050505; color: #ccc; font-family: 'Segoe UI', sans-serif; user-select: none; }
        canvas { display: block; cursor: crosshair; }

        /* UI Base */
        .ui-win { position: absolute; background: rgba(16, 18, 20, 0.95); border: 1px solid #444; border-radius: 4px; padding: 8px; box-shadow: 0 0 15px #000; pointer-events: auto; transition: height 0.3s; overflow: hidden; }
        .ui-head { background: linear-gradient(90deg, #222, #333); color: #ec0; padding: 5px; text-align: center; font-weight: bold; border-bottom: 1px solid #555; margin: -8px -8px 8px -8px; border-radius: 4px 4px 0 0; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        
        button { background: #333; border: 1px solid #555; color: #ddd; padding: 4px 10px; cursor: pointer; font-size: 11px; transition: 0.1s; }
        button:hover { background: #555; color: #fff; border-color: #888; }
        .btn-mini { padding: 2px 6px; font-size: 10px; }
        .btn-close { background: #622; border-color: #844; }

        /* System Buttons */
        #sys-btns { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 1000; }

        /* HUD */
        #hud { top: 10px; left: 10px; width: 260px; }
        .bar-wrap { background: #111; height: 14px; border: 1px solid #333; margin-bottom: 3px; position: relative; }
        .bar-fill { height: 100%; transition: width 0.1s linear; }
        .bar-txt { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 10px; line-height: 14px; color: #fff; text-shadow: 1px 1px 0 #000; }
        
        /* Skill Bar */
        #skill-bar { bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; }
        .skill-slot { width: 50px; height: 50px; background: #222; border: 2px solid #555; position: relative; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: #777; }
        .skill-cd { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; color:#fff; font-size:16px; display:none; border: 1px solid #f00; }
        .key-hint { position: absolute; top:2px; left:2px; font-size:10px; color:#aaa; }

        /* Right Panel */
        #panel { top: 50px; right: 10px; width: 280px; max-height: 85vh; display: flex; flex-direction: column; }
        #panel-content { transition: opacity 0.2s; }
        #inv-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px; max-height: 200px; overflow-y: auto; background: #080808; padding: 3px; border: 1px inset #333; }
        .slot { width: 40px; height: 40px; background: #1a1a1a; border: 1px solid #333; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 9px; text-align: center; }
        .slot:hover { border-color: #aaa; background: #2a2a2a; }

        /* Rarity Effects */
        .r-0 { border-color: #555; color: #aaa; }
        .r-1 { border-color: #282; color: #4f4; }
        .r-2 { border-color: #248; color: #4af; }
        .r-3 { border-color: #628; color: #d4f; }
        .r-4 { border-color: #a60; color: #fa0; box-shadow: inset 0 0 5px #a60; }
        .r-5 { border-color: #900; color: #f22; animation: pulse 1.5s infinite; }
        .r-6 { border-color: #0ff; color: #0ff; box-shadow: 0 0 10px #0ff; animation: glow 1s infinite alternate; }
        
        /* Modals */
        .modal { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; display: none; z-index: 100; }
        
        /* Chat */
        #chat { bottom: 10px; left: 10px; width: 350px; height: 200px; background: rgba(0,0,0,0.5); pointer-events: none; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; }
        .msg { font-size: 12px; text-shadow: 1px 1px 0 #000; padding: 1px; }
        .c-sys { color: #aaa; } .c-get { color: #0f0; } .c-dmg { color: #f55; } .c-rare { color: #fa0; font-weight: bold; }

        /* Boss Bar */
        #boss-ui { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); width: 600px; display: none; pointer-events: none; }
        #boss-hp { width: 100%; height: 25px; background: #200; border: 2px solid #f00; position: relative; }
        #boss-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #900); transition: width 0.1s; }
        #boss-name { text-align:center; color:#fff; font-weight:bold; text-shadow:2px 2px 0 #000; margin-bottom:5px; font-size: 16px; }

        @keyframes pulse { 0% { border-color: #f00; } 50% { border-color: #800; } 100% { border-color: #f00; } }
        @keyframes glow { from { box-shadow: 0 0 5px #0ff; } to { box-shadow: 0 0 15px #0ff; } }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="sys-btns">
        <button onclick="game.save(true)">Ï†ÄÏû•</button>
        <button onclick="game.reset()">Ï¥àÍ∏∞Ìôî</button>
    </div>

    <div id="boss-ui">
        <div id="boss-name">BOSS NAME</div>
        <div id="boss-hp"><div id="boss-fill"></div></div>
    </div>

    <!-- HUD -->
    <div id="hud" class="ui-win">
        <div class="ui-head"><span>Ï†ïÎ≥¥</span></div>
        <div style="font-size:12px; margin-bottom:5px; text-align:center;">
            <span id="u-name">Player</span> (Lv.<span id="u-lv">1</span>) <span style="color:#aaa" id="u-job">Ï†ÑÏÇ¨</span>
        </div>
        <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="background:#c33; width:100%"></div><div class="bar-txt">HP</div></div>
        <div class="bar-wrap"><div id="mp-bar" class="bar-fill" style="background:#33c; width:100%"></div><div class="bar-txt">MP</div></div>
        <div class="bar-wrap"><div id="exp-bar" class="bar-fill" style="background:#ca0; width:0%"></div><div class="bar-txt">EXP</div></div>
        <div style="font-size:11px; display:flex; justify-content:space-between; margin-top:4px;">
            <span style="color:gold">GOLD: <span id="u-gold">0</span></span>
            <span style="color:#aaa" id="u-zone">ÏßÄÏó≠</span>
        </div>
    </div>

    <!-- Skill Bar -->
    <div id="skill-bar">
        <div class="skill-slot" id="slot-q"><span class="key-hint">Q</span><span class="icon"></span><div class="skill-cd" id="cd-q"></div></div>
        <div class="skill-slot" id="slot-w"><span class="key-hint">W</span><span class="icon"></span><div class="skill-cd" id="cd-w"></div></div>
        <div class="skill-slot" id="slot-e"><span class="key-hint">E</span><span class="icon"></span><div class="skill-cd" id="cd-e"></div></div>
        <div class="skill-slot" style="border-color:#a33"><span class="key-hint">P</span>üß™<span style="position:absolute; bottom:2px; right:2px; font-size:10px;" id="u-pot">0</span></div>
    </div>

    <!-- Right Panel -->
    <div id="panel" class="ui-win">
        <div class="ui-head">
            <span>Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥</span>
            <button class="btn-mini" onclick="game.ui.togglePanel()">‚ñº</button>
        </div>
        <div id="panel-content">
            <div style="font-size:11px; margin-bottom:5px; margin-top:5px;">
                Í≥µÍ≤©Î†•: <span id="st-atk">0</span> | Î∞©Ïñ¥Î†•: <span id="st-def">0</span><br>
                Ïä§ÌÉØ Ìè¨Ïù∏Ìä∏: <span id="st-pt" style="color:#f55">0</span>
            </div>
            <div style="display:flex; gap:2px; margin-bottom:5px;">
                <button onclick="game.player.upStat('str')">Ìûò</button>
                <button onclick="game.player.upStat('dex')">ÎØºÏ≤©</button>
                <button onclick="game.player.upStat('con')">Ï≤¥Î†•</button>
            </div>
            <div style="border-top:1px solid #444; padding-top:5px;">
                <div style="font-size:11px; color:#888;">Ïû•ÎπÑ</div>
                <div style="display:flex; gap:5px;">
                    <div id="eq-w" class="slot">Î¨¥Í∏∞</div>
                    <div id="eq-a" class="slot">Í∞ëÏò∑</div>
                </div>
            </div>
            <div class="ui-head" style="margin-top:10px; font-size:11px;">Ïù∏Î≤§ÌÜ†Î¶¨ (<span id="inv-cnt">0</span>)</div>
            <div id="inv-grid"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2px; margin-top:5px;">
                <button onclick="game.ui.toggleShop()">ÏÉÅÏ†ê</button>
                <button onclick="game.ui.toggleSmith()">ÎåÄÏû•Í∞Ñ</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="shop-modal" class="ui-win modal">
        <div class="ui-head">ÏÉÅÏ†ê <button class="btn-close" onclick="game.ui.closeModals()">X</button></div>
        <div id="shop-list" style="max-height:300px; overflow-y:auto;"></div>
    </div>
    
    <div id="smith-modal" class="ui-win modal">
        <div class="ui-head">ÎåÄÏû•Í∞Ñ <button class="btn-close" onclick="game.ui.closeModals()">X</button></div>
        <div style="padding:10px; text-align:center;">
            <div style="border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px;">
                <h4 style="margin:0 0 5px 0; color:#fa0;">[ Ïû•ÎπÑ Í∞ïÌôî ]</h4>
                <div id="smith-slot" class="slot" style="margin:0 auto 5px auto; width:50px; height:50px;" onclick="game.smith.clear('up')">ÏÑ†ÌÉù</div>
                <button style="width:80%; padding:5px;" onclick="game.smith.upgrade()">Í∞ïÌôî ÏãúÎèÑ (1000G)</button>
            </div>
            <div>
                <h4 style="margin:0 0 5px 0; color:#0ff;">[ Í∞ÅÏù∏ Î∂ÄÏó¨ ]</h4>
                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:5px;">
                    <div id="smith-en-item" class="slot" style="width:50px; height:50px;" onclick="game.smith.clear('enItem')">Ïû•ÎπÑ</div>
                    <div id="smith-en-stone" class="slot" style="width:50px; height:50px; border-radius:50%; border-color:#a0a;" onclick="game.smith.clear('enStone')">Í∞ÅÏù∏ÏÑù</div>
                </div>
                <button style="width:80%; padding:5px;" onclick="game.smith.engrave()">Í∞ÅÏù∏ ÌïòÍ∏∞ (500G)</button>
            </div>
        </div>
    </div>

    <!-- Job Select -->
    <div id="job-select" class="ui-win modal" style="display:block; text-align:center;">
        <div class="ui-head">ÏßÅÏóÖ ÏÑ†ÌÉù</div>
        <div style="padding:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button style="padding:15px;" onclick="game.setJob(0)"><b>Ï†ÑÏÇ¨</b><br><span style="font-size:10px; color:#aaa">Í∑ºÏ†ë/Ïù¥ÏÜç 3.0</span></button>
            <button style="padding:15px;" onclick="game.setJob(1)"><b>Í∂ÅÏàò</b><br><span style="font-size:10px; color:#aaa">ÏõêÍ±∞Î¶¨/Ïù¥ÏÜç 2.2</span></button>
            <button style="padding:15px;" onclick="game.setJob(2)"><b>ÎßàÎ≤ïÏÇ¨</b><br><span style="font-size:10px; color:#aaa">Í¥ëÏó≠/Ïù¥ÏÜç 2.2</span></button>
            <button style="padding:15px;" onclick="game.setJob(3)"><b>ÏïîÏÇ¥Ïûê</b><br><span style="font-size:10px; color:#aaa">ÏπòÎ™Ö/Ïù¥ÏÜç 4.2</span></button>
            <button style="padding:15px; grid-column: span 2;" onclick="game.setJob(4)"><b>ÏÑ±Í∏∞ÏÇ¨</b><br><span style="font-size:10px; color:#aaa">Î∞©Ïñ¥/Ïù¥ÏÜç 3.0</span></button>
        </div>
    </div>

    <div id="chat"></div>
</div>

<script>
/**
 * Config & Constants
 */
const CANVAS = document.getElementById('gameCanvas');
const CTX = CANVAS.getContext('2d');
let SCREEN_W = window.innerWidth;
let SCREEN_H = window.innerHeight;
const WORLD_W = 8000;
const WORLD_H = 8000;

// Zones
const ZONES = [
    { name: "ÌèâÌôîÏùò Ïà≤", color: "#1a2b1a", x: 0, y: 0, w: 4000, h: 4000, lv: 1 },
    { name: "Ìô©Î¨¥ÏßÄ", color: "#3d3018", x: 4000, y: 0, w: 4000, h: 4000, lv: 2 },
    { name: "ÏÑ§Ïõê", color: "#15202b", x: 0, y: 4000, w: 3000, h: 4000, lv: 3 },
    { name: "ÏßÄÏò•", color: "#220505", x: 3000, y: 4000, w: 3000, h: 4000, lv: 4 },
    { name: "ÎßπÎèÖÏùò Îä™", color: "#1a2205", x: 6000, y: 4000, w: 2000, h: 2000, lv: 5 },
    { name: "Ï≤úÍ≥µÏùò ÏÑ¨", color: "#445566", x: 6000, y: 6000, w: 2000, h: 2000, lv: 6 }
];

const TOWNS = [
    { name: "Î©îÏù∏ ÎßàÏùÑ", x: 2000, y: 2000, r: 400 },
    { name: "ÏÇ¨Îßâ Ï†ÑÏ¥àÍ∏∞ÏßÄ", x: 6000, y: 2000, r: 300 },
    { name: "ÏñºÏùå ÏöîÏÉà", x: 1500, y: 6000, r: 300 },
    { name: "ÏµúÌõÑÏùò Î≥¥Î£®", x: 4500, y: 6000, r: 300 },
    { name: "Îä™ÏßÄ Ïò§ÎëêÎßâ", x: 7000, y: 5000, r: 200 },
    { name: "Ï≤úÍ≥µ Ïã†Ï†Ñ", x: 7000, y: 7000, r: 200 }
];

const RARITY = [
    { n: 'ÏùºÎ∞ò', c: '#aaa', cl: 'r-0', m: 1 },
    { n: 'Í≥†Í∏â', c: '#4f4', cl: 'r-1', m: 1.3 },
    { n: 'Ìù¨Í∑Ä', c: '#4af', cl: 'r-2', m: 1.8 },
    { n: 'ÏòÅÏõÖ', c: '#d4f', cl: 'r-3', m: 2.5 },
    { n: 'Ï†ÑÏÑ§', c: '#fa0', cl: 'r-4', m: 4.0 },
    { n: 'Ïã†Ìôî', c: '#f22', cl: 'r-5', m: 7.0 },
    { n: 'ÌÉúÍ≥†', c: '#0ff', cl: 'r-6', m: 12.0 }
];

const ENGRAVES = [
    { id: 'vamp', n: 'Ìù°Ìòà' }, { id: 'crit', n: 'ÏπòÎ™Ö' }, { id: 'exe', n: 'Ï≤òÌòï' },
    { id: 'blast', n: 'Ìè≠Î∞ú' }, { id: 'stun', n: 'Í∏∞Ï†à' }, { id: 'spd', n: 'Ïã†ÏÜç' }
];

// V10: Speed Balancing
const JOBS = [
    { n: 'Ï†ÑÏÇ¨', hp: 1.2, mp: 0.8, range: 60, spd: 3.0, icons: ['‚öîÔ∏è','üå™Ô∏è','‚ö°'] },
    { n: 'Í∂ÅÏàò', hp: 0.8, mp: 1.0, range: 250, spd: 2.2, icons: ['üèπ','üåßÔ∏è','üí®'] },
    { n: 'ÎßàÎ≤ïÏÇ¨', hp: 0.7, mp: 1.5, range: 200, spd: 2.2, icons: ['üî•','‚ùÑÔ∏è','‚ú®'] },
    { n: 'ÏïîÏÇ¥Ïûê', hp: 0.9, mp: 1.0, range: 60, spd: 4.2, icons: ['üó°Ô∏è','‚ò†Ô∏è','üëª'] },
    { n: 'ÏÑ±Í∏∞ÏÇ¨', hp: 1.4, mp: 1.2, range: 60, spd: 3.0, icons: ['üî®','üõ°Ô∏è','‚úùÔ∏è'] }
];

/**
 * Utils
 */
function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function getDist(e1, e2) { return Math.hypot(e1.x - e2.x, e1.y - e2.y); }
function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }
function log(msg, type='c-sys') {
    const p = document.getElementById('chat');
    p.innerHTML += `<div class="msg ${type}">${msg}</div>`;
    p.scrollTop = p.scrollHeight;
}
function spawnFloat(txt, x, y, col) {
    game.particles.push({
        type: 'text', txt: txt, x: x, y: y, col: col, life: 60,
        update: function() { this.y -= 0.5; this.life--; },
        draw: function(ctx, cam) {
            ctx.fillStyle = this.col; ctx.font = "bold 12px sans-serif";
            ctx.fillText(this.txt, this.x - cam.x, this.y - cam.y);
        }
    });
}

/**
 * Classes
 */
class Item {
    constructor(lv, type) {
        this.id = Math.random().toString(36).substr(2);
        this.type = type || (Math.random()<0.5 ? 'w' : 'a');
        if(type === 's') { this.name = "Í∞ÅÏù∏ÏÑù"; this.rarity = 2; this.price = 200; return; }
        
        const r = Math.random();
        let ri = 0;
        if(r < 0.0002) ri = 6; else if(r < 0.001) ri = 5; else if(r < 0.005) ri = 4;
        else if(r < 0.03) ri = 3; else if(r < 0.15) ri = 2; else if(r < 0.4) ri = 1;

        const info = RARITY[ri];
        this.rarity = ri;
        this.power = Math.floor((lv * 2 + 5) * info.m * rand(90,110)/100);
        this.up = 0;
        this.engrave = null;
        this.name = `${info.n} ${this.type==='w'?'Í≤Ä':'Í∞ëÏò∑'}`;
        this.price = Math.floor(this.power * 5);

        if(ri >= 4) {
            const effects = ['Î≤àÍ∞ú', 'ÌôîÏóº', 'ÎπôÍ≤∞'];
            this.effect = effects[rand(0,2)];
            this.name = `${this.effect}Ïùò ${this.name}`;
        }
    }
}

class Entity {
    constructor(x, y, sz, col) {
        this.x = x; this.y = y; this.size = sz; this.col = col;
        this.hp = 100; this.maxHp = 100; this.dead = false;
        this.effects = [];
    }
    draw(ctx, cam) {
        if(this.x < cam.x-100 || this.x > cam.x+SCREEN_W+100 || this.y < cam.y-100 || this.y > cam.y+SCREEN_H+100) return;
        
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath(); ctx.ellipse(this.x-cam.x, this.y+this.size/2-cam.y, this.size/1.5, this.size/3, 0, 0, Math.PI*2); ctx.fill();

        ctx.fillStyle = this.col;
        ctx.fillRect(this.x - this.size/2 - cam.x, this.y - this.size/2 - cam.y, this.size, this.size);

        const rx = this.x - 15 - cam.x; const ry = this.y - this.size - 8 - cam.y;
        ctx.fillStyle = '#000'; ctx.fillRect(rx, ry, 30, 4);
        ctx.fillStyle = (this.hp/this.maxHp)>0.5 ? '#0f0' : '#f00';
        ctx.fillRect(rx, ry, 30 * (this.hp/this.maxHp), 4);
    }
    updateEffects() {
        if(this.dead) return;
        this.effects = this.effects.filter(e => e.time > 0);
        this.effects.forEach(e => {
            e.time--;
            if(e.type === 'poison' && e.time % 60 === 0) { this.takeDamage(e.val, true); spawnFloat("ÎèÖ", this.x, this.y-30, '#0f0'); }
            if(e.type === 'burn' && e.time % 30 === 0) { this.takeDamage(e.val, true); spawnFloat("ÌôîÏÉÅ", this.x, this.y-30, '#f50'); }
        });
    }
    addEffect(type, time, val) { this.effects.push({type, time, val}); }
}

class Player extends Entity {
    constructor() {
        super(2000, 2000, 20, '#fff');
        this.level = 1; this.exp = 0; this.maxExp = 100;
        this.gold = 0; this.inv = []; this.eq = { w:null, a:null };
        this.stats = { str:5, dex:5, con:5, pt:0 };
        this.job = 0;
        this.mp = 100; this.maxMp = 100;
        this.potions = 5;
        this.target = null; this.dest = null;
        this.lastAtk = 0;
        this.skills = { q:0, w:0, e:0 }; 
        this.spd = 4;
        this.atkAnim = 0;
    }

    update() {
        if(this.dead) return;
        this.updateEffects();
        if(game.frame % 60 === 0) {
            this.hp = Math.min(this.maxHp, this.hp + this.stats.con*0.2);
            this.mp = Math.min(this.maxMp, this.mp + 2);
        }
        for(let k in this.skills) if(this.skills[k]>0) this.skills[k]--;

        if(this.target && !this.target.dead) {
            const range = JOBS[this.job].range;
            const dist = getDist(this, this.target);
            
            if(this.dest) {
                this.moveTo(this.dest.x, this.dest.y);
                if(getDist(this, this.dest) < 5) this.dest = null;
            } else if(dist > range) {
                this.moveTo(this.target.x, this.target.y);
            }

            if(dist <= range) {
                if(Date.now() - this.lastAtk > Math.max(200, 1000 - this.stats.dex*10)) {
                    this.attack(this.target);
                }
            }
        } else if(this.dest) {
            if(getDist(this, this.dest) < 5) this.dest = null;
            else this.moveTo(this.dest.x, this.dest.y);
        }

        if(this.atkAnim > 0) this.atkAnim--;
    }

    moveTo(tx, ty) {
        if(this.effects.some(e => e.type === 'freeze')) return;
        const rad = Math.atan2(ty - this.y, tx - this.x);
        this.x += Math.cos(rad) * this.spd;
        this.y += Math.sin(rad) * this.spd;
        this.x = clamp(this.x, 0, WORLD_W); this.y = clamp(this.y, 0, WORLD_H);
    }

    attack(t, multi=1.0, isSkill=false) {
        this.lastAtk = Date.now();
        this.atkAnim = 15;

        let dmg = (this.stats.str * 2 + (this.eq.w ? this.eq.w.power + this.eq.w.up*5 : 0)) * multi;
        let isCrit = false;
        
        const engrave = this.eq.w ? this.eq.w.engrave : null;
        if(engrave) {
            if(engrave.id === 'crit' && Math.random() < 0.2) { dmg *= 2; isCrit = true; }
            if(engrave.id === 'exe' && (t.hp/t.maxHp)<0.3) dmg *= 1.5;
            if(engrave.id === 'vamp') {
                const heal = Math.ceil(dmg * 0.1);
                this.hp = Math.min(this.maxHp, this.hp + heal);
                spawnFloat(`+${heal}`, this.x, this.y-30, '#0f0');
            }
        }

        if(this.job === 3 && Math.random() < 0.4) { dmg *= 2.0; isCrit = true; } 

        dmg = Math.floor(dmg * (0.9 + Math.random()*0.2));
        t.takeDamage(dmg);

        const ang = Math.atan2(t.y - this.y, t.x - this.x);
        if(!isSkill) {
            // V10: Pretty Slash
            game.particles.push({
                type: 'slash', x: t.x, y: t.y, ang: ang, life: 12,
                col: this.eq.w && this.eq.w.rarity >= 4 ? '#0ff' : '#fff'
            });
        }
        
        if(this.job !== 0 && this.job !== 3 && this.job !== 4 && !isSkill) {
             game.particles.push({
                type: 'proj', x: this.x, y: this.y, tx: t.x, ty: t.y, life: 20,
                col: this.job===1 ? '#ff0' : '#0af'
            });
        }

        spawnFloat(dmg, t.x, t.y-20, isCrit?'#ff0':'#fff');
        
        if(this.eq.w && this.eq.w.effect) {
            if(Math.random() < 0.3) {
                if(this.eq.w.effect === 'Î≤àÍ∞ú') {
                    spawnFloat("‚ö°", t.x, t.y-40, '#ff0');
                    t.takeDamage(dmg * 0.5);
                } else if(this.eq.w.effect === 'ÌôîÏóº') {
                    t.addEffect('burn', 180, this.level);
                } else if(this.eq.w.effect === 'ÎπôÍ≤∞') {
                    t.addEffect('freeze', 60, 0);
                }
            }
        }
    }

    useSkill(key) {
        if(this.skills[key] > 0) return;
        if(this.mp < 20) { log("MPÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§."); return; }
        this.mp -= 20;
        this.skills[key] = 300; 
        
        const t = this.target;
        const x = this.x, y = this.y;

        if(this.job === 0) { // Warrior
            if(key==='q' && t) { this.attack(t, 2.5, true); game.particles.push({type:'shock', x:t.x, y:t.y, col:'#f00', life:20}); }
            else if(key==='w') { game.monsters.forEach(m => { if(getDist(this, m) < 120) this.attack(m, 0.8, true); }); game.particles.push({type:'spin', x:x, y:y, col:'#fa0', life:20}); }
            else if(key==='e') { this.hp = Math.min(this.maxHp, this.hp + this.maxHp*0.3); spawnFloat("HEAL", x, y-30, '#0f0'); game.particles.push({type:'aura', x:x, y:y, col:'#0f0', life:30}); }
        } 
        else if(this.job === 1) { // Archer
            if(key==='q' && t) { this.attack(t, 0.8, true); setTimeout(()=>this.attack(t, 0.8, true), 200); }
            else if(key==='w' && t) { for(let i=0; i<5; i++) setTimeout(() => { game.particles.push({type:'proj', x:t.x+rand(-50,50), y:t.y-100, tx:t.x, ty:t.y, life:10, col:'#ff0'}); this.attack(t, 0.4, true); }, i*100); }
            else if(key==='e') { const ang = t ? Math.atan2(this.y-t.y, this.x-t.x) : 0; this.x += Math.cos(ang)*150; this.y += Math.sin(ang)*150; }
        }
        else if(this.job === 2) { // Mage
            if(key==='q' && t) { game.particles.push({type:'proj', x:x, y:y, tx:t.x, ty:t.y, life:30, col:'#f50', size:10}); setTimeout(() => { this.attack(t, 3.0, true); game.particles.push({type:'explosion', x:t.x, y:t.y, col:'#f50', life:30}); }, 300); }
            else if(key==='w') { game.monsters.forEach(m => { if(getDist(this, m) < 200) { this.attack(m, 0.5, true); m.addEffect('freeze', 120, 0); } }); game.particles.push({type:'aura', x:x, y:y, col:'#0ff', life:40}); }
            else if(key==='e') { const ang = Math.random() * Math.PI * 2; this.x += Math.cos(ang)*200; this.y += Math.sin(ang)*200; game.particles.push({type:'shock', x:this.x, y:this.y, col:'#00f', life:20}); }
        }
        else if(this.job === 3) { // Assassin
            if(key==='q' && t) { this.x = t.x - 20; this.y = t.y; this.attack(t, 3.0, true); game.particles.push({type:'slash', x:t.x, y:t.y, ang:0, life:10, col:'#505'}); }
            else if(key==='w' && t) { t.addEffect('poison', 300, this.level*2); spawnFloat("POISON", t.x, t.y-30, '#0f0'); }
            else if(key==='e') { this.spd += 2; setTimeout(()=>this.spd-=2, 3000); spawnFloat("SPEED UP", x, y-30, '#fff'); }
        }
        else if(this.job === 4) { // Paladin
            if(key==='q' && t) { this.attack(t, 1.5, true); t.addEffect('stun', 60, 0); game.particles.push({type:'shock', x:t.x, y:t.y, col:'#ff0', life:20}); }
            else if(key==='w') { this.addEffect('shield', 300, 0); spawnFloat("SHIELD", x, y-30, '#ff0'); }
            else if(key==='e') { this.hp = Math.min(this.maxHp, this.hp + this.maxHp*0.2); game.monsters.forEach(m=>{if(getDist(this,m)<150) this.attack(m,1.0,true)}); game.particles.push({type:'aura', x:x, y:y, col:'#ff0', life:30}); }
        }
    }

    takeDamage(d, ignoreDef=false) {
        if(this.effects.some(e=>e.type==='shield')) d *= 0.5;
        const def = ignoreDef ? 0 : (this.stats.con*0.5 + (this.eq.a ? this.eq.a.power + this.eq.a.up*5 : 0));
        const minDmg = d * 0.2; 
        const real = Math.max(minDmg, d - def);
        
        this.hp -= real;
        spawnFloat(Math.floor(real), this.x, this.y-20, '#f00');
        if(this.hp <= 0) {
            log("ÏÇ¨ÎßùÌñàÏäµÎãàÎã§.", "c-dmg");
            this.x=2000; this.y=2000; this.hp=this.maxHp; this.mp=this.maxMp;
            this.dead = false; this.effects = [];
            game.save();
        }
    }
}

class Monster extends Entity {
    constructor(zone) {
        let type = 0; 
        if(Math.random() < 0.01) type = 2;
        else if(Math.random() < 0.05) type = 1;

        let x, y;
        if(type===2) { x=zone.x+zone.w/2; y=zone.y+zone.h/2; }
        else { x=rand(zone.x, zone.x+zone.w); y=rand(zone.y, zone.y+zone.h); }

        let scale = zone.lv;
        if(type===1) scale *= 2;
        if(type===2) scale *= 5;

        const cols = ['#4f4', '#da4', '#adf', '#f55', '#4d4', '#88f'];
        let col = cols[zone.lv-1];
        if(type===1) col = '#fb0';
        if(type===2) col = '#f00';

        super(x, y, 20 + scale*4, col);
        this.type = type;
        this.name = type===2 ? `[BOSS] ${zone.name} Ï£ºÏù∏` : (type===1 ? `[Elite] ${zone.name} ÏàòÌò∏Ïûê` : 'Î™¨Ïä§ÌÑ∞');
        this.level = scale * 5;
        this.maxHp = 50 * scale * scale;
        this.hp = this.maxHp;
        this.atk = 5 * scale;
        this.exp = 10 * scale;
        this.gold = rand(5, 15) * scale;
        this.spd = 1.5 + (Math.random()*0.5);
        
        this.patTimer = 0;
    }

    update(p) {
        if(this.dead) return;
        this.updateEffects();
        if(this.effects.some(e => e.type === 'freeze' || e.type === 'stun')) return;

        const dist = getDist(this, p);
        
        if(this.type === 2 && dist < 800) {
            game.activeBoss = this;
            this.bossBehavior(p, dist);
            return;
        }

        if(dist < 400) {
            if(dist <= this.size+10) {
                if(this.anim === 0) {
                    this.anim = 60; 
                    if(this.type > 0) game.particles.push({type:'charge', x:this.x, y:this.y, col:this.col, life:30});
                    setTimeout(() => {
                        if(!this.dead && getDist(this, p) <= this.size+20) {
                            p.takeDamage(this.atk);
                            if(this.type>0) game.particles.push({type:'shock', x:p.x, y:p.y, col:'#f00', life:15});
                        }
                    }, 500);
                }
            } else {
                const ang = Math.atan2(p.y - this.y, p.x - this.x);
                this.x += Math.cos(ang) * this.spd;
                this.y += Math.sin(ang) * this.spd;
            }
        }
        if(this.anim > 0) this.anim--;
    }

    bossBehavior(p, dist) {
        this.patTimer++;
        if(this.patTimer > 180) { 
            this.patTimer = 0;
            const action = rand(0, 2);
            if(action === 0) { // AoE
                game.particles.push({type:'aoe_warn', x:p.x, y:p.y, life:60, size:100});
                setTimeout(() => {
                    if(getDist(p, {x:p.x, y:p.y}) < 100) p.takeDamage(this.atk * 1.5);
                    game.particles.push({type:'explosion', x:p.x, y:p.y, col:'#f00', life:30, size:100});
                }, 1000);
            } else if(action === 1) { // Barrage
                for(let i=0; i<5; i++) {
                    setTimeout(() => {
                        game.particles.push({type:'proj', x:this.x, y:this.y, tx:p.x+rand(-50,50), ty:p.y+rand(-50,50), life:40, col:'#f00', size:8, enemy:true, atk:this.atk});
                    }, i*100);
                }
            } else { // Dash
                const ang = Math.atan2(p.y - this.y, p.x - this.x);
                this.x += Math.cos(ang) * 300; this.y += Math.sin(ang) * 300;
                game.particles.push({type:'slash', x:this.x, y:this.y, ang:ang, life:20, col:'#fff'});
                if(getDist(this, p) < 50) p.takeDamage(this.atk);
            }
        }
        if(dist > 50) {
            const ang = Math.atan2(p.y - this.y, p.x - this.x);
            this.x += Math.cos(ang) * (this.spd * 0.5);
            this.y += Math.sin(ang) * (this.spd * 0.5);
        }
    }

    takeDamage(d, ignoreDef=false) {
        this.hp -= d;
        if(this.hp <= 0) {
            this.dead = true;
            game.player.exp += this.exp;
            game.player.gold += this.gold;
            if(game.player.exp >= game.player.maxExp) {
                game.player.level++; game.player.exp=0; game.player.maxExp*=1.2;
                game.player.stats.pt += 3; game.player.maxHp+=20; game.player.hp=game.player.maxHp;
                spawnFloat("LEVEL UP", this.x, this.y-40, '#ff0');
                game.ui.updatePanel();
            }
            if(this.type===2 && game.activeBoss === this) {
                document.getElementById('boss-ui').style.display = 'none';
                game.activeBoss = null;
            }
            this.drop();
        }
    }

    drop() {
        if(Math.random() < 0.3) {
            const item = new Item(this.level);
            game.player.inv.push(item);
            log(`${item.name} ÌöçÎìù`, item.rarity>=3?'c-rare':'c-get');
            game.ui.updatePanel();
        }
        if(this.type > 0 && Math.random() < 0.5) {
            game.player.inv.push(new Item(1, 's'));
            log("Í∞ÅÏù∏ÏÑù ÌöçÎìù", 'c-rare');
            game.ui.updatePanel();
        }
    }
}

class Game {
    constructor() {
        this.player = new Player();
        this.monsters = [];
        this.particles = [];
        this.cam = { x:0, y:0 };
        this.frame = 0;
        this.activeBoss = null;
        
        this.ui = new UI(this);
        this.smith = new Smith(this);
        
        this.init();
    }

    init() {
        CANVAS.addEventListener('mousedown', e => {
            const r = CANVAS.getBoundingClientRect();
            const wx = e.clientX - r.left + this.cam.x;
            const wy = e.clientY - r.top + this.cam.y;
            
            let t = null;
            for(let i=this.monsters.length-1; i>=0; i--) {
                const m = this.monsters[i];
                if(!m.dead && getDist({x:wx, y:wy}, m) < m.size+15) { t = m; break; }
            }

            if(t) {
                this.player.target = t;
                this.player.dest = null;
                game.particles.push({type:'shock', x:t.x, y:t.y, col:'#f00', life:10, size:30});
            } else {
                this.player.dest = {x:wx, y:wy};
                game.particles.push({type:'shock', x:wx, y:wy, col:'#0f0', life:10, size:10});
            }
        });
        
        CANVAS.addEventListener('dblclick', e => { this.player.target = null; });

        window.addEventListener('keydown', e => {
            if(['q','w','e'].includes(e.key.toLowerCase())) this.player.useSkill(e.key.toLowerCase());
            if(e.key.toLowerCase() === 'p') {
                if(this.player.potions > 0) {
                    this.player.potions--;
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + this.player.maxHp*0.5);
                    spawnFloat("HP UP", this.player.x, this.player.y-30, '#0f0');
                }
            }
            if(e.key === 'Escape') this.player.target = null;
        });

        window.addEventListener('resize', () => {
            SCREEN_W = window.innerWidth; SCREEN_H = window.innerHeight;
            CANVAS.width = SCREEN_W; CANVAS.height = SCREEN_H;
        });
        CANVAS.width = SCREEN_W; CANVAS.height = SCREEN_H;

        if(localStorage.getItem('rpg_v10') || localStorage.getItem('rpg_v8')) {
            this.load();
            document.getElementById('job-select').style.display = 'none';
        }
        
        this.ui.updatePanel();
        this.ui.updateIcons();

        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    setJob(id) {
        this.player.job = id;
        this.player.maxHp *= JOBS[id].hp; this.player.hp = this.player.maxHp;
        this.player.maxMp *= JOBS[id].mp; this.player.mp = this.player.maxMp;
        this.player.spd = JOBS[id].spd;
        document.getElementById('job-select').style.display = 'none';
        this.ui.updatePanel();
        this.ui.updateIcons();
        log(`${JOBS[id].n}Î°ú Î™®ÌóòÏùÑ ÏãúÏûëÌï©ÎãàÎã§.`);
    }

    loop() {
        this.frame++;
        
        this.monsters = this.monsters.filter(m => !m.dead);
        if(this.monsters.length < 90) { 
            const z = ZONES[rand(0, ZONES.length-1)];
            const mx = rand(z.x, z.x+z.w);
            const my = rand(z.y, z.y+z.h);
            let safe = false;
            for(let t of TOWNS) { if(getDist({x:mx, y:my}, t) < t.r + 100) safe = true; }
            if(!safe) {
                const m = new Monster(z); m.x = mx; m.y = my;
                this.monsters.push(m);
            }
        }

        this.activeBoss = null;
        this.player.update();
        this.monsters.forEach(m => m.update(this.player));

        const bossUi = document.getElementById('boss-ui');
        if(this.activeBoss && !this.activeBoss.dead) {
            bossUi.style.display = 'block';
            document.getElementById('boss-name').innerText = this.activeBoss.name;
            document.getElementById('boss-fill').style.width = (this.activeBoss.hp / this.activeBoss.maxHp * 100) + '%';
        } else {
            bossUi.style.display = 'none';
        }

        this.cam.x = clamp(this.player.x - SCREEN_W/2, 0, WORLD_W - SCREEN_W);
        this.cam.y = clamp(this.player.y - SCREEN_H/2, 0, WORLD_H - SCREEN_H);

        const ctx = CTX;
        ctx.fillStyle = '#111'; ctx.fillRect(0,0,SCREEN_W,SCREEN_H);

        ZONES.forEach(z => {
            if(z.x+z.w > this.cam.x && z.x < this.cam.x+SCREEN_W && z.y+z.h > this.cam.y && z.y < this.cam.y+SCREEN_H) {
                ctx.fillStyle = z.color; ctx.fillRect(z.x - this.cam.x, z.y - this.cam.y, z.w, z.h);
            }
        });
        
        TOWNS.forEach(t => {
             if(t.x+t.r > this.cam.x && t.x-t.r < this.cam.x+SCREEN_W) {
                 ctx.fillStyle = 'rgba(0,0,0,0.5)';
                 ctx.beginPath(); ctx.arc(t.x-this.cam.x, t.y-this.cam.y, t.r, 0, Math.PI*2); ctx.fill();
                 ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.font = "16px serif";
                 ctx.fillText(t.name, t.x-this.cam.x, t.y-this.cam.y);
             }
        });

        this.monsters.forEach(m => m.draw(ctx, this.cam));
        this.player.draw(ctx, this.cam);

        if(this.player.atkAnim > 0) {
            ctx.save();
            ctx.translate(this.player.x - this.cam.x, this.player.y - this.cam.y);
            let ang = 0;
            if(this.player.target) ang = Math.atan2(this.player.target.y - this.player.y, this.player.target.x - this.player.x);
            else if(this.player.dest) ang = Math.atan2(this.player.dest.y - this.player.y, this.player.dest.x - this.player.x);
            
            ctx.rotate(ang + (this.player.atkAnim/15)); 
            
            ctx.fillStyle = this.player.eq.w ? RARITY[this.player.eq.w.rarity].c : '#ccc';
            ctx.shadowBlur = this.player.eq.w && this.player.eq.w.rarity >= 4 ? 10 : 0;
            ctx.shadowColor = ctx.fillStyle;
            ctx.fillRect(10, -2, 30, 4); 
            ctx.restore();
        }

        // V10: Pretty Particles
        this.particles = this.particles.filter(p => p.life > 0);
        this.particles.forEach(p => {
            p.update && p.update();
            if(p.type === 'text') p.draw(ctx, this.cam);
            else if(p.type === 'slash') {
                ctx.save(); 
                ctx.translate(p.x-this.cam.x, p.y-this.cam.y); 
                ctx.rotate(p.ang);
                ctx.globalCompositeOperation = 'lighter';
                ctx.fillStyle = p.col;
                ctx.beginPath();
                ctx.arc(0, 0, 60, -0.5, 0.5);
                ctx.fill();
                ctx.restore(); 
                p.life--;
            }
            else if(p.type === 'proj') {
                p.x += (p.tx - p.x) * 0.2; p.y += (p.ty - p.y) * 0.2;
                ctx.save();
                ctx.globalCompositeOperation = 'lighter';
                ctx.fillStyle = p.col; ctx.beginPath(); ctx.arc(p.x-this.cam.x, p.y-this.cam.y, p.size||6, 0, Math.PI*2); ctx.fill();
                // Trail
                ctx.globalAlpha = 0.5;
                ctx.beginPath(); ctx.arc(p.x-this.cam.x - (p.tx-p.x)*0.1, p.y-this.cam.y - (p.ty-p.y)*0.1, p.size||4, 0, Math.PI*2); ctx.fill();
                ctx.restore();
                if(p.enemy && getDist(p, this.player) < 20) { this.player.takeDamage(p.atk); p.life=0; }
                p.life--;
            }
            else if(p.type === 'explosion') {
                ctx.save();
                ctx.globalCompositeOperation = 'lighter';
                ctx.fillStyle = p.col; ctx.globalAlpha = p.life/30;
                ctx.beginPath(); ctx.arc(p.x-this.cam.x, p.y-this.cam.y, p.size||50, 0, Math.PI*2); ctx.fill();
                ctx.restore();
                p.life--;
            }
            else if(p.type === 'aoe_warn') {
                 ctx.strokeStyle = '#f00'; ctx.lineWidth = 2; ctx.globalAlpha = 0.5;
                 ctx.beginPath(); ctx.arc(p.x-this.cam.x, p.y-this.cam.y, p.size, 0, Math.PI*2); ctx.stroke();
                 ctx.fillStyle = 'rgba(255,0,0,0.2)'; ctx.fill(); ctx.globalAlpha = 1.0;
                 p.life--;
            }
            else if(p.type === 'shock' || p.type === 'spin' || p.type === 'aura') {
                ctx.save();
                ctx.globalCompositeOperation = 'lighter';
                ctx.strokeStyle = p.col; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(p.x-this.cam.x, p.y-this.cam.y, (40-p.life)*2, 0, Math.PI*2); ctx.stroke(); 
                ctx.restore();
                p.life--;
            }
        });

        if(this.player.target && !this.player.target.dead) {
            const t = this.player.target;
            ctx.strokeStyle = '#f00'; ctx.lineWidth = 1; ctx.beginPath(); ctx.arc(t.x-this.cam.x, t.y-this.cam.y, t.size+10, 0, Math.PI*2); ctx.stroke();
        }

        if(this.frame % 3600 === 0) this.save();

        this.ui.updateHUD();

        requestAnimationFrame(this.loop);
    }

    // V10: Robust Save Logic
    save(manual = false) {
        const p = this.player;
        // Save only data, not the object itself to avoid circular refs
        const saveData = {
            level: p.level, exp: p.exp, maxExp: p.maxExp,
            gold: p.gold, hp: p.hp, maxHp: p.maxHp, mp: p.mp, maxMp: p.maxMp,
            stats: p.stats, job: p.job, potions: p.potions,
            inv: p.inv, eq: p.eq, x: p.x, y: p.y
        };
        localStorage.setItem('rpg_v10', JSON.stringify(saveData));
        if(manual) alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
    }

    reset() {
        if(confirm("Ï†ïÎßê Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            localStorage.removeItem('rpg_v10');
            location.reload();
        }
    }

    load() {
        try {
            // V10: Try V10 first, then fallbacks
            let json = localStorage.getItem('rpg_v10') || localStorage.getItem('rpg_v8') || localStorage.getItem('rpg_v7');
            if(json) {
                const d = JSON.parse(json);
                const p = this.player;
                
                // Restore simple props
                p.level = d.level; p.exp = d.exp; p.maxExp = d.maxExp;
                p.gold = d.gold; p.hp = d.hp; p.maxHp = d.maxHp; p.mp = d.mp; p.maxMp = d.maxMp;
                p.stats = d.stats; p.job = d.job; p.potions = d.potions;
                p.x = d.x; p.y = d.y;
                
                // Restore speed based on job
                p.spd = JOBS[p.job].spd;

                // Re-instantiate Items
                const restoreItem = (i) => {
                    const n = new Item(1);
                    Object.assign(n, i);
                    return n;
                };

                p.inv = d.inv.map(restoreItem);
                if(d.eq.w) p.eq.w = restoreItem(d.eq.w);
                if(d.eq.a) p.eq.a = restoreItem(d.eq.a);

                this.ui.updatePanel();
                this.ui.updateIcons();
                log("Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å.");
            }
        } catch(e) { console.error("Load Failed", e); }
    }
}

class UI {
    constructor(g) { this.g = g; this.panelOpen = true; }

    updateHUD() {
        const p = this.g.player;
        document.getElementById('u-lv').innerText = p.level;
        document.getElementById('u-gold').innerText = p.gold.toLocaleString();
        document.getElementById('u-pot').innerText = p.potions;
        
        document.getElementById('hp-bar').style.width = (p.hp/p.maxHp*100)+'%';
        document.getElementById('mp-bar').style.width = (p.mp/p.maxMp*100)+'%';
        document.getElementById('exp-bar').style.width = (p.exp/p.maxExp*100)+'%';

        ['q','w','e'].forEach(k => {
            const el = document.getElementById(`cd-${k}`);
            if(p.skills[k] > 0) {
                el.style.display = 'flex';
                el.innerText = Math.ceil(p.skills[k]/60);
            } else el.style.display = 'none';
        });
    }

    updateIcons() {
        const j = JOBS[this.g.player.job];
        document.querySelector('#slot-q .icon').innerText = j.icons[0];
        document.querySelector('#slot-w .icon').innerText = j.icons[1];
        document.querySelector('#slot-e .icon').innerText = j.icons[2];
    }

    updatePanel() {
        if(!this.panelOpen) return;
        const p = this.g.player;
        document.getElementById('u-job').innerText = JOBS[p.job].n;
        document.getElementById('st-atk').innerText = Math.floor(p.stats.str*2 + (p.eq.w?p.eq.w.power+p.eq.w.up*5:0));
        document.getElementById('st-def').innerText = Math.floor(p.stats.con*0.5 + (p.eq.a?p.eq.a.power+p.eq.a.up*5:0));
        document.getElementById('st-pt').innerText = p.stats.pt;
        document.getElementById('inv-cnt').innerText = p.inv.length;

        const setEq = (id, it, type) => {
            const el = document.getElementById(id);
            el.innerHTML = it ? `<span style="color:${RARITY[it.rarity].c}">${it.name}</span>` : (type==='w'?'Î¨¥Í∏∞':'Í∞ëÏò∑');
            el.className = it ? `slot ${RARITY[it.rarity].cl}` : 'slot';
            el.onclick = () => { if(it) { p.inv.push(it); if(type==='w') p.eq.w=null; else p.eq.a=null; this.updatePanel(); } };
        };
        setEq('eq-w', p.eq.w, 'w'); setEq('eq-a', p.eq.a, 'a');

        const grid = document.getElementById('inv-grid');
        grid.innerHTML = '';
        p.inv.forEach((it, i) => {
            const d = document.createElement('div');
            d.className = `slot ${RARITY[it.rarity].cl}`;
            d.innerHTML = it.type==='s' ? 'Í∞ÅÏù∏ÏÑù' : it.name;
            if(it.up > 0) d.innerHTML += ` (+${it.up})`;
            if(it.engrave) d.innerHTML += ` <span style='color:#0ff'>‚òÖ</span>`;
            
            d.onclick = () => {
                if(document.getElementById('smith-modal').style.display==='block') {
                    if(it.type === 's') game.smith.selStone(it, i);
                    else game.smith.sel(it, i);
                } else if(it.type !== 's') {
                    if(it.type==='w') { if(p.eq.w) p.inv.push(p.eq.w); p.eq.w=it; }
                    else { if(p.eq.a) p.inv.push(p.eq.a); p.eq.a=it; }
                    p.inv.splice(i, 1);
                    this.updatePanel();
                }
            };
            d.oncontextmenu = (e) => { e.preventDefault(); if(document.getElementById('shop-modal').style.display==='block') { p.gold+=it.price; p.inv.splice(i,1); this.updatePanel(); } };
            grid.appendChild(d);
        });
    }

    togglePanel() {
        this.panelOpen = !this.panelOpen;
        const content = document.getElementById('panel-content');
        if(this.panelOpen) {
            content.style.opacity = '1';
            content.style.pointerEvents = 'auto';
            setTimeout(() => content.style.display = 'block', 0);
            this.updatePanel();
        } else {
            content.style.opacity = '0';
            content.style.pointerEvents = 'none';
            setTimeout(() => content.style.display = 'none', 200);
        }
    }

    toggleShop() {
        this.closeModals();
        const p = this.g.player;
        if(!TOWNS.some(t => getDist(p, t) < t.r)) { log("ÎßàÏùÑÏù¥ ÏïÑÎãôÎãàÎã§."); return; }
        document.getElementById('shop-modal').style.display='block';
        const l = document.getElementById('shop-list'); l.innerHTML='';
        const items = [
            {n:'Ï≤¥Î†• Î¨ºÏïΩ (10G)', p:10, f:()=>{p.potions++;}},
            {n:'ÎûúÎç§ Ïû•ÎπÑ (500G)', p:500, f:()=>{p.inv.push(new Item(p.level));}},
            {n:'Í≥†Í∏â Ïû•ÎπÑ (2000G)', p:2000, f:()=>{p.inv.push(new Item(p.level));}}
        ];
        items.forEach(i => {
            const b = document.createElement('button');
            b.innerText = i.n; b.style.width='100%'; b.style.marginBottom='5px';
            b.onclick = () => { if(p.gold>=i.p) { p.gold-=i.p; i.f(); this.updatePanel(); } else log("Í≥®Îìú Î∂ÄÏ°±"); };
            l.appendChild(b);
        });
        this.updatePanel();
    }
    toggleSmith() {
        this.closeModals();
        if(!TOWNS.some(t => getDist(this.g.player, t) < t.r)) { log("ÎßàÏùÑÏù¥ ÏïÑÎãôÎãàÎã§."); return; }
        document.getElementById('smith-modal').style.display='block';
    }
    closeModals() { document.querySelectorAll('.modal').forEach(e=>e.style.display='none'); }
}

class Smith {
    constructor(g) { this.g = g; this.item = null; this.iIdx = -1; this.stone = null; this.sIdx = -1; }
    
    sel(it, i) {
        this.item = it; this.iIdx = i;
        const el1 = document.getElementById('smith-slot'); el1.className = `slot ${RARITY[it.rarity].cl}`; el1.innerHTML = it.name;
        const el2 = document.getElementById('smith-en-item'); el2.className = `slot ${RARITY[it.rarity].cl}`; el2.innerHTML = it.name;
    }
    
    selStone(it, i) {
        this.stone = it; this.sIdx = i;
        const el = document.getElementById('smith-en-stone'); el.className = `slot ${RARITY[it.rarity].cl}`; el.innerHTML = "Í∞ÅÏù∏ÏÑù";
    }

    clear(t) {
        if(t==='up' || t==='enItem') { 
            this.item=null; 
            document.getElementById('smith-slot').className='slot'; document.getElementById('smith-slot').innerHTML='ÏÑ†ÌÉù';
            document.getElementById('smith-en-item').className='slot'; document.getElementById('smith-en-item').innerHTML='Ïû•ÎπÑ';
        }
        if(t==='enStone') {
            this.stone=null;
            document.getElementById('smith-en-stone').className='slot'; document.getElementById('smith-en-stone').innerHTML='Í∞ÅÏù∏ÏÑù';
        }
    }

    upgrade() {
        if(!this.item) return;
        const p = this.g.player;
        if(p.gold < 1000) { log("Í≥®Îìú Î∂ÄÏ°±"); return; }
        p.gold -= 1000;
        if(Math.random() < 0.7) {
            this.item.up++; this.item.power += 5; log("Í∞ïÌôî ÏÑ±Í≥µ!", "c-get");
        } else log("Í∞ïÌôî Ïã§Ìå®...", "c-dmg");
        this.g.ui.updatePanel();
        this.sel(this.item, this.iIdx);
    }

    engrave() {
        if(!this.item || !this.stone) { log("Ïû•ÎπÑÏôÄ Í∞ÅÏù∏ÏÑùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."); return; }
        const p = this.g.player;
        if(p.gold < 500) { log("Í≥®Îìú Î∂ÄÏ°±"); return; }
        p.gold -= 500;
        p.inv.splice(this.sIdx, 1);
        const eff = ENGRAVES[rand(0, ENGRAVES.length-1)];
        this.item.engrave = eff;
        log(`Í∞ÅÏù∏ ÏÑ±Í≥µ: [${eff.n}]`, "c-rare");
        spawnFloat("ENGRAVE!", p.x, p.y-50, '#0ff');
        this.stone = null; this.sIdx = -1;
        document.getElementById('smith-en-stone').className='slot'; document.getElementById('smith-en-stone').innerHTML='Í∞ÅÏù∏ÏÑù';
        this.g.ui.updatePanel();
    }
}

const game = new Game();
</script>
</body>
</html>
